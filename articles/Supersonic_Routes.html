<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="himach">
<title>Introduction to Supersonic Routing • himach</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to Supersonic Routing">
<meta property="og:description" content="himach">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">himach</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.2.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Supersonic_Routes.html">Introduction to Supersonic Routing</a>
    <a class="dropdown-item" href="../articles/Supersonic_Routes_in_depth.html">Advanced Supersonic Routing</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/david6marsh/himach/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Introduction to Supersonic Routing</h1>
                        <h4 data-toc-skip class="author">David
Marsh</h4>
            
            <h4 data-toc-skip class="date">2023-10-12</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/david6marsh/himach/blob/HEAD/vignettes/Supersonic_Routes.Rmd" class="external-link"><code>vignettes/Supersonic_Routes.Rmd</code></a></small>
      <div class="d-none name"><code>Supersonic_Routes.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette provides an end-to-end example of using the
<code>himach</code> package to find the quickest route for a supersonic
(“high Mach”) aircraft that is allowed to fly supersonic over sea, but
only subsonic over land.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#the libraries needed for the vignette are</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/david6marsh/himach" class="external-link">himach</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span>, quietly <span class="op">=</span> <span class="cn">TRUE</span>, warn.conflicts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Linking to GEOS 3.10.2, GDAL 3.4.1, PROJ 8.2.1; sf_use_s2() is TRUE</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/s2/" class="external-link">s2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ropenscilabs/rnaturalearthdata" class="external-link">rnaturalearthdata</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; The legacy packages maptools, rgdal, and rgeos, underpinning the sp package,</span></span>
<span><span class="co">#&gt; which was just loaded, were retired in October 2023.</span></span>
<span><span class="co">#&gt; Please refer to R-spatial evolution reports for details, especially</span></span>
<span><span class="co">#&gt; https://r-spatial.org/r/2023/05/15/evolution4.html.</span></span>
<span><span class="co">#&gt; It may be desirable to make the sf package available;</span></span>
<span><span class="co">#&gt; package maintainers should consider adding sf to Suggests:.</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="aircraft">Aircraft<a class="anchor" aria-label="anchor" href="#aircraft"></a>
</h2>
<p>You need a dataframe that defines one or more aircraft. This needs,
at minimum, to have the following fields:</p>
<ul>
<li>
<code>id</code> and <code>type</code>: a very short, and longer text
identifier for this aircraft</li>
<li>
<code>over_sea_M</code> and <code>over_land_M</code>: two speeds,
given as a Mach number</li>
<li>
<code>accel_Mpm</code>: acceleration in Mach per minute between
these two</li>
<li>
<code>arrdep_kph</code>: the speed on arrival and departure from
airport, given in km per hour</li>
<li>
<code>range_km</code>: range in km</li>
</ul>
<p>Other fields are optional, but it is recommended to include
<code>notes</code> to give more information.</p>
<p>To convert between kph and Mach at the sort of cruise altitudes that
supersonic aircraft use, we use a fixed value
<code>mach_kph</code>=1062.</p>
<p>The cruise speeds over sea and over land are clearly intended to be
supersonic and subsonic, respectively. But this is not required. You
might want both subsonic, to include a comparator, subsonic aircraft. Or
you might want to have both supersonic, to explore routes when so-called
“mach cut-off” conditions prevail. <code>himach</code> doesn’t require
either speed to be within a particular range of values.</p>
<p>Run this minimum dataset through <code>make_aircraft</code> to get
the additional fields that are needed. Alternatively, if you run
<code>make_aircraft</code> with no parameters, it creates a set of test
aircraft. This test set is based on public data for 3 aircraft (though
the <code>accel_Mpm</code>, <code>arrdep_kph</code> are educated
guesses), and fantasy for the 4th one, which has been designed for
testing purposes and might not be pleasant to fly in.</p>
<p><code>make_aircraft</code> adds some fields, converting Mach to kph,
and calculating the time to transition between the two speeds. This
‘transition penalty’ <code>trans_h</code> in hours, is used in the
routing search as a time penalty whenever a transition from subsonic to
supersonic (or vice versa) is needed; typically this is when switching
from flying over land to flying over sea (or vice versa).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># example for your own data - see above for column headings</span></span>
<span><span class="co"># aircraft &lt;- read.csv("data/aircraft.csv", stringAsFactors = FALSE)</span></span>
<span><span class="co"># aircraft &lt;- make_aircraft(aircraft)</span></span>
<span><span class="co"># strongly recommended to record the source file name for later reference</span></span>
<span><span class="co"># this works even better if your source file has a date embedded in the name</span></span>
<span><span class="co"># attr(aircraft, "aircraftSet") &lt;- "aircraft.csv"</span></span>
<span></span>
<span><span class="co"># example if you have no data of your own - know that this will use default, so turn off warning</span></span>
<span><span class="va">aircraft</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_aircraft.html">make_aircraft</a></span><span class="op">(</span>warn <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="airports">Airports<a class="anchor" aria-label="anchor" href="#airports"></a>
</h2>
<p>Similarly, we need a dataset describing airports. This needs, at
minimum, to have the following fields:</p>
<ul>
<li>
<code>APICAO</code>: the 4-character ICAO code for the airport</li>
<li>
<code>long</code> and <code>lat</code>: the longitude and latitude,
in decimal degrees (E and N being positive)</li>
</ul>
<p>Other fields are optional, but you might find it useful to include a
longer airport name <code>ap_name</code> to give more information, as
well as other fields containing geographical details, such as
country.</p>
<p>As with the aircraft, you can load your own data set and then run it
through <code>make_airports</code> to add a geo-coded field to it. If
you don’t have a list, then <code>make_airports</code> will use the
dataset from <code>airportr</code> package.</p>
<p>For this vignette, we use a very restricted set: just New Zealand. We
geocode the airports using a built-in coordinate reference system (CRS)
<code>crs_Pacific</code>; the maps will have the same.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># example for your own data</span></span>
<span><span class="co"># airports &lt;- read.csv("data/airports.csv", stringAsFactors = FALSE)</span></span>
<span><span class="co"># airports &lt;- make_airports(airports)</span></span>
<span></span>
<span><span class="co"># example if you have no data of your own</span></span>
<span><span class="va">airports</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_airports.html">make_airports</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="va">crs_Pacific</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">APICAO</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">==</span><span class="st">"N"</span><span class="op">)</span> <span class="co">#just New Zealand, and neighbours</span></span>
<span><span class="co">#&gt; Using default airport data: airportr::airport.</span></span></code></pre></div>
<p>In fact you need two airport sets, because you need to say where
flights can stop to refuel. If an aircraft cannot make a journey in a
single leg, due to lack of range, <code>himach</code> automatically
searches for the best refuelling option. This can easily multiply the
number of searches by 5 or 10, so choose a limited number of likely
‘good’ options: islands, coastal points, or on narrow segments of land
where the aircraft would have to slow down anyway. In our theoretical
example, we have a test aircraft with an artificially-reduced range, and
we make just one refuel point available: coastal and central at the same
time, Wellington.</p>
<p>The refuelling dataset needs to be the same format as the full
airports set. So easiest is to filter the airports set, or do an inner
join if your refuelling list is a dataset read in from a file.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">refuel_ap</span> <span class="op">&lt;-</span> <span class="va">airports</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">APICAO</span><span class="op">==</span><span class="st">"NZWN"</span><span class="op">)</span></span></code></pre></div>
<p>For the vignette, we’ll assume that Wellington has a long enough
runway. In fact <code>himach</code> does not currently check whether a
runway is long enough for the aircraft selected.</p>
</div>
<div class="section level2">
<h2 id="maps">Maps<a class="anchor" aria-label="anchor" href="#maps"></a>
</h2>
<p>Next you need a set of shapefiles covering your area of interest
(usually worldwide). These need only to distinguish land and sea, but
starting off at country level can be useful, for example to filter out
the Antarctic, which is not likely to see traffic. You can save time by
ignoring airspace South of 60S, for example.</p>
<p>Finer resolution is better, because small islands can become larger
obstacles. After a no-fly coastal buffer, say around 30km wide, is
applied, even a 1km wide island is an obstacle 61km wide. There are some
useful starter maps in <code>rnaturalearth</code> (use the
<code>countries</code> versions), but you need to decide what is good
enough for your purposes. Two tests:</p>
<ul>
<li>If you have a 30km buffer do you have aircraft passing between Crete
and mainland Greece without slowing down? Then you’re missing the island
of Antikythera, famous for its ancient, analogue computer.</li>
<li>With a 50km buffer, do you have routes passing supersonically
between Taiwan and the Philippines? Then you are missing either Y’Ami or
Xiao-lan Yu, which are just 98km apart.</li>
</ul>
<p>Licensing and your intended use may influence which maps are
available to you. We have used data from Eurostat in the past (at 1:1M
scale, <a href="https://ec.europa.eu/eurostat/web/gisco/geodata/reference-data/administrative-units-statistical-units/countries" class="external-link">Eurostat
country shape files</a>). For the purpose of rapid testing and this
vignette, we use a map which is provided by <a href="https://datafinder.stats.govt.nz" class="external-link">Stats NZ</a> (as at January
2020) and licensed by Stats NZ for re-use under the Creative Commons
Attribution 4.0 International licence.</p>
<p>In fact, we need two files: one is the basic outline of the land,
largely used for visualisation; the second is derived from this, and
adds a 30km buffer around the coastline to indicate the area where
supersonic flight is not allowed. A different buffer is of course
possible, 30km is about right for the expected radius of the footprint
of the supersonic boom, but your expertise will determine what is
needed.</p>
<p>Since the shape file is large, we provide a simplified outline
<code>NZ_coast</code> and also the buffer <code>NZ_buffer30</code>
within <code>himach</code>. These are in the original projection used by
Stats NZ. For global work, it’s strongly recommended to use one of the
following:</p>
<ul>
<li>
<code>crs_Atlantic</code>: “Robinson”, a mid 20C classic view, with
Atlantic centre</li>
<li>
<code>crs_Pacific</code>: A Pacific-centred variant on this with
<code>crs=sf::st_CRS("+proj=robin +lon_0=180 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs")</code>.</li>
</ul>
<p>We leave this transformation step in the process to emphasise the
need to think about which projection to use.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># if you are using your own shp file </span></span>
<span><span class="co"># NZ_shp &lt;- sf::read_sf("...../territorial-authority-2020-clipped-generalised.shp")</span></span>
<span><span class="co"># NZ_coast &lt;- NZ_shp %&gt;% sf::st_simplify(dTolerance = 1000) %&gt;% sf::st_union()</span></span>
<span><span class="co"># NZ_buffer30 &lt;- NZ_coast %&gt;% sf::st_buffer(30 * 1000) %&gt;% sf::st_union()</span></span>
<span></span>
<span><span class="co"># get test datasets</span></span>
<span><span class="va">NZ_coast</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hm_get_test.html">hm_get_test</a></span><span class="op">(</span><span class="st">"coast"</span><span class="op">)</span></span>
<span><span class="va">NZ_buffer30</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hm_get_test.html">hm_get_test</a></span><span class="op">(</span><span class="st">"buffer"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The in-built test maps are already in crs_Pacific</span></span>
<span><span class="co"># All that remains is to illustrate the land and buffer</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">NZ_buffer30</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="cn">NA</span>, fill <span class="op">=</span> <span class="st">"grey75"</span><span class="op">)</span>  <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">NZ_coast</span>, fill <span class="op">=</span> <span class="st">"grey90"</span>, colour <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Supersonic_Routes_files/figure-html/load_maps-1.png" width="700"></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># a quicker way to do all of this is to use map_routes, with no routes</span></span>
<span><span class="co"># by default map_routes simplifies maps to a coarse 10km step</span></span>
<span><span class="co"># for this small example we want something finer-grained</span></span>
<span><span class="fu"><a href="../reference/map_routes.html">map_routes</a></span><span class="op">(</span><span class="va">NZ_coast</span>, fat_map <span class="op">=</span> <span class="va">NZ_buffer30</span>, crs <span class="op">=</span> <span class="va">crs_Pacific</span>,</span>
<span>           simplify_km <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="Supersonic_Routes_files/figure-html/load_maps-2.png" width="700"></p>
<p>On the scale of this example, the resolution of the map is good. If
you are doing global analysis, then you will need two things: a detailed
map on which to base the coastal buffer (eg
<code>rnaturalearthhires::countries10</code>); and then a simplified
version, because otherwise plotting results will take a long time.</p>
<p>The version in comments in the chunk above uses the basic
<code>sf</code> functionality to simplify and buffer. For reasons that
we go into <a href="Supersonic_Routes_in_depth.html#bufferaccuracy">in
another vignette</a>, it’s probably better to use <code>s2</code> for
adding a buffer. That gives something like the following code (none of
which is used further in this vignette).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># you really want to use rnaturalearthhires::countries10</span></span>
<span><span class="co"># but that's heavy for this vignette</span></span>
<span><span class="va">map_NZ</span> <span class="op">&lt;-</span> <span class="fu">rnaturalearthdata</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/rnaturalearthdata/man/countries.html" class="external-link">countries50</a></span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>   <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">name</span> <span class="op">==</span> <span class="st">"New Zealand"</span><span class="op">)</span></span>
<span><span class="co"># use attributes to track where this came from</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">map_NZ</span>, <span class="st">"source"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"rnaturalearthdata::countries50"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">map_NZ</span>, <span class="st">"Antarctic"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">map_NZ</span>, <span class="st">"simplify_m"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span></span>
<span><span class="co"># using s2 for buffering</span></span>
<span><span class="va">NZ_plus30</span> <span class="op">&lt;-</span> <span class="va">map_NZ</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>   <span class="fu"><a href="https://r-spatial.github.io/sf/reference/s2.html" class="external-link">st_as_s2</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>   <span class="fu">s2</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/s2/reference/s2_boundary.html" class="external-link">s2_buffer_cells</a></span><span class="op">(</span>distance <span class="op">=</span> <span class="fl">30000</span>, max_cells <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>   <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html" class="external-link">st_as_sfc</a></span><span class="op">(</span><span class="op">)</span> </span>
<span><span class="co"># again, use attributes to record the metadata</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">NZ_plus30</span>,<span class="st">"buffer_m"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">30000</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">NZ_plus30</span>,<span class="st">"max_cells"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span></span>
<span><span class="co"># and then simplify for plotting</span></span>
<span><span class="co"># just give 1 example here</span></span>
<span><span class="va">map_NZ_2k</span> <span class="op">&lt;-</span> <span class="va">map_NZ</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>   <span class="fu"><a href="https://r-spatial.github.io/sf/reference/s2.html" class="external-link">st_as_s2</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>   <span class="fu">s2</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/s2/reference/s2_boundary.html" class="external-link">s2_simplify</a></span><span class="op">(</span>tolerance <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>   <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html" class="external-link">st_as_sfc</a></span><span class="op">(</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">map_NZ_2k</span>, <span class="st">"simplify_m"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">2000</span></span>
<span></span>
<span><span class="co"># example map, himach::map_routes but without any routes</span></span>
<span><span class="co"># by default map_routes simplifies maps to a coarse 10km step</span></span>
<span><span class="co"># for this small example we want something finer-grained</span></span>
<span><span class="fu"><a href="../reference/map_routes.html">map_routes</a></span><span class="op">(</span><span class="va">map_NZ_2k</span>, fat_map <span class="op">=</span> <span class="va">NZ_plus30</span>, crs <span class="op">=</span> <span class="va">crs_Pacific</span>, </span>
<span>           simplify_km <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="Supersonic_Routes_files/figure-html/mapswiths2-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="create-a-grid">Create a grid<a class="anchor" aria-label="anchor" href="#create-a-grid"></a>
</h2>
<p>The route is constructed on a grid that covers the entire map. You
could think of this grid as being a regular network of waypoints and
route segments at some high, cruise flight level, though
<code>himach</code> doesn’t assign a flight level to it. The links in
this grid have nominal length: 30-40km appears sufficient, though we
will use a coarser grid for this test. By ‘nominal’ we mean that the
grid is constructed not on a strict distance basis, but between points
along particular lines of latitude, so the links vary in length.</p>
<p>To this are added connections to airports. These connections have a
nominal or target length, say 150km, to represent the distance covered
when accelerating to cruise speed, or decelerating back when landing. In
practice, the length varies, because it depends on the (horizontal)
distance from airport to grid.</p>
<p>It can take a very long time to construct a global grid. For our
much-reduced example the time might be 2-3 seconds. We wrap a
<code>system.time</code> call around the creation, to give some idea of
the timing. It’s roughly proportional to the square of
<code>1/target_km</code>, so if you halve the grid size, you double the
time.</p>
<p>Normally the grid is too large to plot helpfully, but in this very
limited set, it can be visualised.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">target_km</span> <span class="op">&lt;-</span> <span class="fl">150</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span></span>
<span><span class="va">p_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_route_grid.html">make_route_grid</a></span><span class="op">(</span><span class="va">NZ_buffer30</span>, <span class="st">"NZ lat-long at 150km"</span>,</span>
<span>                             target_km <span class="op">=</span> <span class="va">target_km</span>, classify <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                         lat_min <span class="op">=</span> <span class="op">-</span><span class="fl">49</span>, lat_max <span class="op">=</span> <span class="op">-</span><span class="fl">32</span>, </span>
<span>                         long_min <span class="op">=</span> <span class="fl">162</span>, long_max <span class="op">=</span> <span class="fl">182</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;   1.983   0.040   2.023</span></span>
<span></span>
<span><span class="co"># whether this map is useful depends on the target_km v the overall size of the map</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">NZ_buffer30</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="cn">NA</span>, fill <span class="op">=</span> <span class="st">"grey75"</span><span class="op">)</span>  <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">NZ_coast</span>, fill <span class="op">=</span> <span class="st">"grey90"</span>, colour <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">p_grid</span><span class="op">@</span><span class="va">lattice</span>,</span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>geometry<span class="op">=</span><span class="va">geometry</span><span class="op">)</span>, colour<span class="op">=</span><span class="st">"lightblue"</span>, size <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Supersonic_Routes_files/figure-html/construct_grid-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="routes">Routes!<a class="anchor" aria-label="anchor" href="#routes"></a>
</h2>
<p>Finally we’re ready to do some routing of aircraft.</p>
<p>The result is a little coarse, because we have used a coarse grid.
<code>himach</code> simplifies sections of route to great circles where
it can, but all points where two great-circle segments join will be
vertices of this grid. You can experiment by using the built-in
<code>NZ_grid</code> instead. That has a 30km resolution, but is built
on the same <code>NZ_buffer</code> map, so nothing else needs to
change.</p>
<p>You can control the amount of reporting during the creation of routes
with the <code>quiet</code> option, cumulatively you get: 0) nothing, 1)
route &amp; legs, 2) major stages (envelope, phases, shortcuts) 3) use
of cache, route stages &amp; some timings.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span><span class="st">"quiet"</span> <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="co">#for some output</span></span>
<span><span class="co"># from Auckland to Christchurch</span></span>
<span><span class="va">ap2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_AP2.html">make_AP2</a></span><span class="op">(</span><span class="st">"NZAA"</span>,<span class="st">"NZCH"</span>,<span class="va">airports</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># normally you do NOT want to do this, but for the vignette we</span></span>
<span><span class="co"># work with an empty cache</span></span>
<span><span class="fu"><a href="../reference/hm_clean_cache.html">hm_clean_cache</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">routes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_route.html">find_route</a></span><span class="op">(</span><span class="va">aircraft</span><span class="op">[</span><span class="fl">4</span>,<span class="op">]</span>, </span>
<span>                     <span class="va">ap2</span>,</span>
<span>                     fat_map <span class="op">=</span> <span class="va">NZ_buffer30</span>, </span>
<span>                     route_grid <span class="op">=</span> <span class="va">p_grid</span>, </span>
<span>                     ap_loc <span class="op">=</span> <span class="va">airports</span><span class="op">)</span></span>
<span><span class="co">#&gt; Route:-NZAA&lt;&gt;NZCH----</span></span>
<span><span class="co">#&gt;   Not cached: calculating...</span></span>
<span><span class="co">#&gt; Leg: NZAA&lt;&gt;NZCH Aircraft: Test-only SST</span></span>
<span><span class="co">#&gt;   Starting envelope: 0</span></span>
<span><span class="co">#&gt;  Cut envelope from lattice: 0.1</span></span>
<span><span class="co">#&gt;   TOC/TOD not cached: calculating...</span></span>
<span><span class="co">#&gt;   TOC/TOD not cached: calculating...</span></span>
<span><span class="co">#&gt;   Got costed lattice: 0.3</span></span>
<span><span class="co">#&gt;   Got path: 0.3</span></span>
<span><span class="co">#&gt;  Calculated phase changes</span></span>
<span><span class="co">#&gt;   Ready to recurse</span></span>
<span><span class="co">#&gt;   transition 1.  2</span></span>
<span><span class="co">#&gt;   sea 2.  2</span></span>
<span><span class="co">#&gt;   transition 3.  4</span></span>
<span><span class="co">#&gt;  Done recursion</span></span>
<span><span class="co">#&gt;  Checking Shortcuts</span></span></code></pre></div>
<p>In fact, normally you’ll want to run a selection of routes in one
batch. While <code>find_route</code> takes only one aircraft and one
airport-pair, there is a wrapper which takes a list of aircraft ids (as
in the first column in the aircraft data), and a 2-column matrix or
dataframe of 4-letter ICAO codes. It creates all combinations of these,
and runs <code>find_route</code> for each. This wrapper function is
called <code>find_routes</code>.</p>
<p>There is a progress bar, though this interacts with the progress
messaging and the remaining time estimate tends to be too high because
calculation speeds up as the cache fills up.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span><span class="st">"quiet"</span> <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="co"># anything more than 1 is messy, because of the progress bar</span></span>
<span><span class="va">ap2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"NZAA"</span>,<span class="st">"NZCH"</span>,<span class="st">"NZAA"</span>,<span class="st">"NZDN"</span>,<span class="st">"NZGS"</span>,<span class="st">"NZCH"</span><span class="op">)</span>, </span>
<span>              ncol <span class="op">=</span> <span class="fl">2</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">ac</span> <span class="op">&lt;-</span> <span class="va">aircraft</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">4</span><span class="op">)</span>, <span class="op">]</span><span class="op">$</span><span class="va">id</span></span>
<span></span>
<span><span class="va">routes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_routes.html">find_routes</a></span><span class="op">(</span><span class="va">ac</span>, <span class="va">ap2</span>, <span class="va">aircraft</span>, <span class="va">airports</span>,</span>
<span>                      fat_map <span class="op">=</span> <span class="va">NZ_buffer30</span>, </span>
<span>                     route_grid <span class="op">=</span> <span class="va">p_grid</span>,</span>
<span>                     refuel <span class="op">=</span> <span class="va">refuel_ap</span><span class="op">)</span></span>
<span><span class="co">#&gt; Route:-NZAA&lt;&gt;NZCH----</span></span>
<span><span class="co">#&gt; Leg: NZAA&lt;&gt;NZCH Aircraft: SST M2.2</span></span>
<span><span class="co">#&gt;  Cut envelope from lattice: 0.1</span></span>
<span><span class="co">#&gt;  Calculated phase changes</span></span>
<span><span class="co">#&gt;  Done recursion</span></span>
<span><span class="co">#&gt;  Checking Shortcuts</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Route:-NZAA&lt;&gt;NZDN----</span></span>
<span><span class="co">#&gt; Leg: NZAA&lt;&gt;NZDN Aircraft: SST M2.2</span></span>
<span><span class="co">#&gt;  Cut envelope from lattice: 0.1</span></span>
<span><span class="co">#&gt;  Calculated phase changes</span></span>
<span><span class="co">#&gt;  Done recursion</span></span>
<span><span class="co">#&gt;  Checking Shortcuts</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Route:-NZCH&lt;&gt;NZGS----</span></span>
<span><span class="co">#&gt; Leg: NZCH&lt;&gt;NZGS Aircraft: SST M2.2</span></span>
<span><span class="co">#&gt;  Cut envelope from lattice: 0.1</span></span>
<span><span class="co">#&gt;  Calculated phase changes</span></span>
<span><span class="co">#&gt;  Done recursion</span></span>
<span><span class="co">#&gt;  Checking Shortcuts</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Route:-NZAA&lt;&gt;NZCH----</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Route:-NZAA&lt;&gt;NZDN----</span></span>
<span><span class="co">#&gt;  Too far for one leg.</span></span>
<span><span class="co">#&gt; Leg: NZAA&lt;&gt;NZWN Aircraft: Test-only SST</span></span>
<span><span class="co">#&gt;  Cut envelope from lattice: 0.1</span></span>
<span><span class="co">#&gt;  Calculated phase changes</span></span>
<span><span class="co">#&gt;  Done recursion</span></span>
<span><span class="co">#&gt;  Checking Shortcuts</span></span>
<span><span class="co">#&gt; Leg: NZDN&lt;&gt;NZWN Aircraft: Test-only SST</span></span>
<span><span class="co">#&gt;  Cut envelope from lattice: 0.1</span></span>
<span><span class="co">#&gt;  Calculated phase changes</span></span>
<span><span class="co">#&gt;  Done recursion</span></span>
<span><span class="co">#&gt;  Checking Shortcuts</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Route:-NZCH&lt;&gt;NZGS----</span></span>
<span><span class="co">#&gt; Leg: NZCH&lt;&gt;NZGS Aircraft: Test-only SST</span></span>
<span><span class="co">#&gt;  Cut envelope from lattice: 0.1</span></span>
<span><span class="co">#&gt;  Calculated phase changes</span></span>
<span><span class="co">#&gt;  Done recursion</span></span>
<span><span class="co">#&gt;  Checking Shortcuts</span></span>
<span><span class="co">#&gt; </span></span></code></pre></div>
<p>Once you have some routes, you will probably want (a) a summary of
the routes created (b) a map. There are functions for both of these.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create route summary</span></span>
<span><span class="va">rtes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/summarise_routes.html">summarise_routes</a></span><span class="op">(</span><span class="va">routes</span>, <span class="va">airports</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># draw a basic map</span></span>
<span><span class="fu"><a href="../reference/map_routes.html">map_routes</a></span><span class="op">(</span><span class="va">NZ_coast</span>, <span class="va">routes</span>, crs <span class="op">=</span> <span class="va">crs_Pacific</span>, fat_map <span class="op">=</span>  <span class="va">NZ_buffer30</span>, simplify_km <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="Supersonic_Routes_files/figure-html/route_summary_and_map-1.png" width="700"></p>
<p>Maps are created with <code>ggplot2</code> so the last map generated
can be saved with <code>ggsave</code> in the usual way.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by David Marsh, EUROCONTROL.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
